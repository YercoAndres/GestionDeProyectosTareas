USE gestion_proyectos_shard3;
GO

/* 2) Tabla USERS (incluye columnas de capacidad/disponibilidad) */

CREATE TABLE dbo.Users (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Name           NVARCHAR(255) NULL,
    Email          NVARCHAR(255) NULL,
    [Password]     NVARCHAR(255) NULL,
    [Role]         VARCHAR(20)   NOT NULL,
    Weekly_Capacity_Hours DECIMAL(5,2) NOT NULL DEFAULT 40,
    Availability_Status    VARCHAR(20) NOT NULL DEFAULT 'available',
    Availability_Notes     NVARCHAR(255) NULL,
    Verify         BIT NOT NULL DEFAULT 0,
    CONSTRAINT CK_Users_Role CHECK ([Role] IN ('user','manager')),
    CONSTRAINT CK_Users_Availability_Status 
        CHECK (Availability_Status IN ('available','limited','unavailable'))
);
GO

/* 3) Tabla PROJECTS (puedes borrar Members después si ya no lo usas) */

CREATE TABLE dbo.Projects (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Name        NVARCHAR(255) NOT NULL,
    [Description] NVARCHAR(255) NOT NULL DEFAULT N'',
    Start_Date  DATE NULL,
    End_Date    DATE NULL,
    Members     NVARCHAR(255) NULL,  -- opcional, se puede eliminar
    [Status]    NVARCHAR(20) NOT NULL DEFAULT N'En progreso',
    CONSTRAINT CK_Projects_Status 
        CHECK ([Status] IN (N'En progreso',N'Completado',N'En pausa'))
);
GO

/* 4) Tabla ROLES (permissions como JSON en NVARCHAR(MAX)) */

CREATE TABLE dbo.Roles (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Role_Key    VARCHAR(50)    NOT NULL,
    Name        NVARCHAR(100)  NOT NULL,
    [Description] NVARCHAR(255) NULL,
    Permissions NVARCHAR(MAX)  NULL,
    Created_At  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    Updated_At  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT UQ_Roles_Role_Key UNIQUE (Role_Key)
);
GO

/* (Opcional) Trigger para mantener Updated_At automáticamente */
CREATE TRIGGER TR_Roles_SetUpdatedAt
ON dbo.Roles
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE r
    SET Updated_At = SYSDATETIME()
    FROM dbo.Roles r
    INNER JOIN inserted i ON r.Id = i.Id;
END;
GO

/* 5) Tabla TASKS (incluye estimated_hours y story_points) */

CREATE TABLE dbo.Tasks (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Project_Id   INT NULL,
    Name         NVARCHAR(255) NULL,
    [Description] NVARCHAR(255) NULL,
    Start_Date   DATE NULL,
    End_Date     DATE NULL,
    Estimated_Hours DECIMAL(10,2) NULL,
    Story_Points INT NULL,
    Priority     VARCHAR(10)  NOT NULL DEFAULT 'Baja',
    Estado       VARCHAR(20)  NOT NULL DEFAULT 'en progreso',
    Responsable_Id INT NULL,
    CONSTRAINT FK_Tasks_Project 
        FOREIGN KEY (Project_Id) REFERENCES dbo.Projects(Id),
    CONSTRAINT FK_Tasks_Responsable 
        FOREIGN KEY (Responsable_Id) REFERENCES dbo.Users(Id),
    CONSTRAINT CK_Tasks_Priority 
        CHECK (Priority IN ('Baja','Media','Alta')),
    CONSTRAINT CK_Tasks_Estado 
        CHECK (Estado IN ('en progreso','completado'))
);
GO

CREATE INDEX IX_Tasks_Project_Id ON dbo.Tasks(Project_Id);
CREATE INDEX IX_Tasks_Responsable_Id ON dbo.Tasks(Responsable_Id);
GO

/* 6) Tabla MILESTONES */

CREATE TABLE dbo.Milestones (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Project_Id INT NOT NULL,
    Name       NVARCHAR(255) NOT NULL,
    [Description] NVARCHAR(MAX) NULL,
    Start_Date DATE NULL,
    Due_Date   DATE NULL,
    [Status]   VARCHAR(20) NOT NULL DEFAULT 'planned',
    Created_At DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    Updated_At DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_Milestones_Project 
        FOREIGN KEY (Project_Id) REFERENCES dbo.Projects(Id) ON DELETE CASCADE,
    CONSTRAINT CK_Milestones_Status 
        CHECK ([Status] IN ('planned','in_progress','completed','delayed'))
);
GO

CREATE INDEX IX_Milestones_Project_Id ON dbo.Milestones(Project_Id);
CREATE INDEX IX_Milestones_Status ON dbo.Milestones([Status]);
GO

/* 7) Tabla PROJECT_MEMBERS (N–N entre proyectos y usuarios + rol de proyecto) */

CREATE TABLE dbo.Project_Members (
    Project_Id INT NOT NULL,
    User_Id    INT NOT NULL,
    Role_Id    INT NULL,
    CONSTRAINT PK_Project_Members PRIMARY KEY (Project_Id, User_Id),
    CONSTRAINT FK_Project_Members_Project 
        FOREIGN KEY (Project_Id) REFERENCES dbo.Projects(Id) ON DELETE CASCADE,
    CONSTRAINT FK_Project_Members_User 
        FOREIGN KEY (User_Id) REFERENCES dbo.Users(Id) ON DELETE CASCADE,
    CONSTRAINT FK_Project_Members_Role 
        FOREIGN KEY (Role_Id) REFERENCES dbo.Roles(Id)
);
GO

CREATE INDEX IX_Project_Members_User_Id ON dbo.Project_Members(User_Id);
CREATE INDEX IX_Project_Members_Role_Id ON dbo.Project_Members(Role_Id);
GO

/* 8) Tabla TOKENS */

CREATE TABLE dbo.Tokens (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Token    NVARCHAR(255) NOT NULL,
    User_Id  INT NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    ExpiresAt DATETIME2 NOT NULL,
    CONSTRAINT FK_Tokens_User 
        FOREIGN KEY (User_Id) REFERENCES dbo.Users(Id) ON DELETE CASCADE
);
GO

CREATE INDEX IX_Tokens_User_Id ON dbo.Tokens(User_Id);
GO

/* 9) Tabla TASK_DEPENDENCIES */

CREATE TABLE dbo.Task_Dependencies (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Task_Id            INT NOT NULL,
    Depends_On_Task_Id INT NOT NULL,
    Dependency_Type    VARCHAR(2) NOT NULL DEFAULT 'FS',
    Note        NVARCHAR(255) NULL,
    Created_At  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    Updated_At  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT UQ_Task_Dependencies 
        UNIQUE (Task_Id, Depends_On_Task_Id),
    CONSTRAINT FK_Task_Dependencies_Task 
        FOREIGN KEY (Task_Id)
        REFERENCES dbo.Tasks(Id) ON DELETE CASCADE,
    CONSTRAINT FK_Task_Dependencies_DependsOn 
        FOREIGN KEY (Depends_On_Task_Id)
        REFERENCES dbo.Tasks(Id),  -- sin ON DELETE CASCADE
    CONSTRAINT CK_Task_Dependencies_Type 
        CHECK (Dependency_Type IN ('FS','FF','SS','SF'))
);
GO

CREATE INDEX IX_Task_Dependencies_Task_Id 
    ON dbo.Task_Dependencies(Task_Id);

CREATE INDEX IX_Task_Dependencies_Depends_On_Task_Id 
    ON dbo.Task_Dependencies(Depends_On_Task_Id);
GO


/* 10) Tabla TIME_ENTRIES */

CREATE TABLE dbo.Time_Entries (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Task_Id     INT NOT NULL,
    Project_Id  INT NOT NULL,
    User_Id     INT NOT NULL,
    Started_At  DATETIME2 NOT NULL,
    Ended_At    DATETIME2 NULL,
    Duration_Minutes INT NOT NULL,
    Note        NVARCHAR(255) NULL,
    Created_At  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    Updated_At  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_Time_Entries_Task 
        FOREIGN KEY (Task_Id) REFERENCES dbo.Tasks(Id),
    CONSTRAINT FK_Time_Entries_Project 
        FOREIGN KEY (Project_Id) REFERENCES dbo.Projects(Id),
    CONSTRAINT FK_Time_Entries_User 
        FOREIGN KEY (User_Id) REFERENCES dbo.Users(Id)
);
GO

CREATE INDEX IX_Time_Entries_Task_Id    ON dbo.Time_Entries(Task_Id);
CREATE INDEX IX_Time_Entries_Project_Id ON dbo.Time_Entries(Project_Id);
CREATE INDEX IX_Time_Entries_User_Id    ON dbo.Time_Entries(User_Id);
GO

/* 11) Datos iniciales de ROLES */

IF NOT EXISTS (SELECT 1 FROM dbo.Roles WHERE Role_Key = 'viewer')
    INSERT INTO dbo.Roles (Role_Key, Name, [Description])
    VALUES ('viewer', N'Observador', N'Puede visualizar proyectos y tareas.');

IF NOT EXISTS (SELECT 1 FROM dbo.Roles WHERE Role_Key = 'collaborator')
    INSERT INTO dbo.Roles (Role_Key, Name, [Description])
    VALUES ('collaborator', N'Colaborador', N'Puede crear y actualizar tareas asignadas.');

IF NOT EXISTS (SELECT 1 FROM dbo.Roles WHERE Role_Key = 'admin')
    INSERT INTO dbo.Roles (Role_Key, Name, [Description])
    VALUES ('admin', N'Administrador de proyecto', N'Puede gestionar miembros, tareas y ajustes del proyecto.');
    
    GO

USE gestion_proyectos;
SELECT * FROM Projects;
USE gestion_proyectos_shard1;
SELECT * FROM Projects;
USE gestion_proyectos_shard2;
SELECT * FROM Projects;
USE gestion_proyectos_shard3;
SELECT * FROM Projects;

use gestion_proyectos;

ALTER DATABASE gestion_proyectos SET RECOVERY BULK_LOGGED;
GO

;WITH N1 AS (SELECT 1 n FROM (VALUES(0),(0),(0),(0),(0),(0),(0),(0),(0),(0)) v(n)), -- 10
N2 AS (SELECT 1 n FROM N1 a CROSS JOIN N1 b),       -- 100
N3 AS (SELECT 1 n FROM N2 a CROSS JOIN N2 b),       -- 10.000
N4 AS (SELECT 1 n FROM N3 a CROSS JOIN N2 b),       -- 1.000.000
N5 AS (
  SELECT TOP (5000000) ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) AS RN
  FROM N4 a CROSS JOIN N2 b -- 1M*100=100M, se recorta a 5M
),
RandomData AS (
  SELECT
    RN AS DummyId,
    CONCAT('Proyecto masivo ', RN) AS Name,
    DATEADD(DAY, RN % 365, '2024-01-01') AS Start_Date,
    DATEADD(DAY, (RN % 365) + 30, '2024-01-01') AS End_Date,
    N'En progreso' AS [Status]
  FROM N5
)
INSERT INTO dbo.Projects (Name, [Description], Start_Date, End_Date, [Status])
SELECT Name, N'', Start_Date, End_Date, [Status]
FROM RandomData;
GO

USE gestion_proyectos_shard1;
WHILE 1 = 1
BEGIN
    DELETE TOP (50000)
    FROM dbo.Projects
    WHERE Name LIKE N'Proyecto masivo %';

    IF @@ROWCOUNT = 0 BREAK;
    CHECKPOINT;
END;

USE master;
GO

CREATE DATABASE gestion_proyectos_shard1;
GO

CREATE DATABASE gestion_proyectos_shard2;
GO

CREATE DATABASE gestion_proyectos_shard3;
GO